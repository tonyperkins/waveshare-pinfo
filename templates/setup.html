<!DOCTYPE html>
<html>
<head>
    <title>Google Photos Album Picker</title>
    <script src="https://accounts.google.com/gsi/client" async defer></script>
    <script src="https://apis.google.com/js/api.js" async defer></script>
    <style>
        body { font-family: Arial, sans-serif; background-color: #f4f4f4; text-align: center; padding-top: 50px; }
        .container { background-color: white; max-width: 500px; margin: auto; padding: 30px; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.1); }
        h1 { color: #333; }
        p { color: #666; }
        #signin-button, #picker-button { display: inline-block; background-color: #4285F4; color: white; padding: 10px 20px; border-radius: 4px; font-size: 16px; cursor: pointer; border: none; margin-top: 20px; }
        #picker-button { display: none; background-color: #34A853; }
        #status { margin-top: 20px; font-weight: bold; }
    </style>
</head>
<body>

    <div class="container">
        <h1>Album Setup</h1>
        <p>Sign in with your Google account and then select the album you want to display on your e-ink frame.</p>
        
        <button id="signin-button" onclick="handleAuthClick()">Sign in with Google</button>
        <button id="picker-button" onclick="createPicker()">Select Album</button>

        <p id="status">Step 1: Please sign in.</p>
        <p>Current Share Token: <code id="currentToken">{{ current_share_token or 'Not Set' }}</code></p>
    </div>

    <script>
        let tokenClient;
        let accessToken;

        const GOOGLE_CLIENT_ID = "{{ google_client_id }}";
        const SCOPES = 'https://www.googleapis.com/auth/photoslibrary.sharing';

        function handleAuthClick() {
            console.log('Auth button clicked. Requesting access token.');
            tokenClient.requestAccessToken();
        }

        function createPicker() {
            console.log('Picker button clicked.');
            if (!accessToken) {
                alert('Authentication token is missing. Please sign in again.');
                return;
            }
            const view = new google.picker.View(google.picker.ViewId.ALBUMS);
            const picker = new google.picker.PickerBuilder()
                .setOAuthToken(accessToken)
                .addView(view)
                .setCallback(pickerCallback)
                .build();
            picker.setVisible(true);
        }

        async function pickerCallback(data) {
            console.log('Picker callback initiated.');
            if (data.action === google.picker.Action.PICKED) {
                const albumId = data.docs[0].id;
                document.getElementById('status').innerText = 'Album selected. Creating shareable link...';
                console.log(`Selected album ID: ${albumId}`);
                
                const shareToken = await getShareableAlbum(albumId);
                if (shareToken) {
                    document.getElementById('status').innerText = 'SUCCESS! Sending token to server...';
                    console.log(`Obtained shareToken: ${shareToken}`);
                    sendTokenToServer(shareToken);
                } else {
                    document.getElementById('status').innerText = 'Error: Could not make the selected album shareable.';
                    console.error('Failed to get shareable album.');
                }
            }
        }

        async function getShareableAlbum(albumId) {
            try {
                const response = await fetch(`https://photoslibrary.googleapis.com/v1/albums/${albumId}:share`,
                {
                    method: 'POST',
                    headers: { 'Authorization': `Bearer ${accessToken}`, 'Content-Type': 'application/json' },
                    body: JSON.stringify({ isCollaborative: false, isCommentable: false })
                });
                const result = await response.json();
                console.log('Share API response:', result);
                return result.shareInfo.shareToken;
            } catch (error) {
                console.error('Error sharing album:', error);
                return null;
            }
        }

        function sendTokenToServer(shareToken) {
            fetch('/token', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ shareToken: shareToken })
            }).then(response => {
                if(response.ok) {
                    document.getElementById('status').innerText = 'Setup complete! The display will update shortly.';
                    document.getElementById('currentToken').innerText = shareToken;
                } else {
                    document.getElementById('status').innerText = 'Error: Failed to send token to server.';
                }
            });
        }

        // Main initialization logic
        window.onload = () => {
            console.log('Window loaded. Initializing Google clients.');
            // Initialize the OAuth Token Client
            tokenClient = google.accounts.oauth2.initTokenClient({
                client_id: GOOGLE_CLIENT_ID,
                scope: SCOPES,
                callback: (tokenResponse) => {
                    console.log('Access token received.');
                    accessToken = tokenResponse.access_token;
                    document.getElementById('signin-button').style.display = 'none';
                    document.getElementById('picker-button').style.display = 'inline-block';
                    document.getElementById('status').innerText = 'Step 2: Click the button to select your album.';
                },
            });

            // Load the Google Picker API
            gapi.load('picker', () => { console.log('Picker API loaded.'); });
        };

    </script>
</body>
</html>
